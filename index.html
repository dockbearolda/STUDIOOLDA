<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Studio Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <style>
        :root { --blue: #007AFF; --gray: #8E8E93; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #F2F2F7; color: #1c1c1e; -webkit-font-smoothing: antialiased; }
        
        /* Design Apple */
        .ios-card { background: white; border-radius: 14px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .ios-input { background: #F2F2F7; border: none; border-radius: 10px; padding: 12px; width: 100%; outline: none; font-size: 16px; appearance: none; }
        .ios-btn { background: var(--blue); color: white; border-radius: 12px; padding: 16px; font-weight: 600; text-align: center; width: 100%; transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .ios-btn:active { opacity: 0.7; transform: scale(0.98); }
        
        /* Point de couleur dynamique */
        .select-wrapper { position: relative; display: flex; align-items: center; }
        .dot { width: 10px; height: 10px; border-radius: 50%; position: absolute; left: 14px; pointer-events: none; border: 1px solid rgba(0,0,0,0.1); transition: background 0.3s; }
        .dot-input { padding-left: 36px !important; }

        /* Toggle Paiement Apple */
        .pay-toggle { display: flex; background: #E3E3E8; border-radius: 10px; padding: 2px; cursor: pointer; position: relative; }
        .pay-opt { flex: 1; text-align: center; padding: 10px; font-size: 13px; font-weight: 700; z-index: 1; transition: 0.2s; color: #8e8e93; }
        .pay-slider { position: absolute; width: calc(50% - 2px); height: calc(100% - 4px); background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .paid .pay-slider { transform: translateX(100%); }
        .paid .opt-on { color: #34C759; }

        .step { display: none; flex-direction: column; gap: 15px; }
        .active { display: flex; animation: slideIn 0.4s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="p-4 max-w-md mx-auto">

    <header class="mb-6 pt-4 flex justify-between items-end">
        <div>
            <p id="step-label" class="text-blue-500 font-bold text-[10px] uppercase tracking-tighter">Étape 1 sur 4</p>
            <h1 id="step-title" class="text-3xl font-bold tracking-tight">Client</h1>
        </div>
        <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center shadow-sm">
            <span id="step-num" class="text-xs font-bold">1</span>
        </div>
    </header>

    <div id="step-1" class="step active">
        <div class="ios-card p-4 space-y-4">
            <input type="text" id="orderNo" class="ios-input text-gray-400 font-mono text-sm" readonly>
            <input type="text" id="clientName" class="ios-input" placeholder="Nom complet">
            <input type="tel" id="clientPhone" class="ios-input" placeholder="Numéro de téléphone">
        </div>
        <button onclick="nav(2)" class="ios-btn">Suivant</button>
    </div>

    <div id="step-2" class="step">
        <div class="ios-card p-4 space-y-4">
            <select id="collection" class="ios-input" onchange="updateRefs()">
                <option value="Aucune">Choisir une collection</option>
                <option>Homme</option><option>Femme</option><option>Enfant</option>
            </select>
            <select id="refSelect" class="ios-input"></select>
            <select id="size" class="ios-input">
                <option>Taille S</option><option>Taille M</option><option>Taille L</option><option>Taille XL</option>
            </select>
            
            <div class="select-wrapper">
                <div id="ts-dot" class="dot"></div>
                <select id="tshirtColor" class="ios-input dot-input" onchange="syncUI(); updatePreview();"></select>
            </div>
            
            <div class="select-wrapper">
                <div id="lg-dot" class="dot"></div>
                <select id="logoColor" class="ios-input dot-input" onchange="syncUI();"></select>
            </div>
        </div>
        <div class="flex gap-3">
            <button onclick="nav(1)" class="ios-btn bg-white !text-gray-400">Retour</button>
            <button onclick="nav(3)" class="ios-btn">Design</button>
        </div>
    </div>

    <div id="step-3" class="step">
        <div class="flex bg-gray-200 p-1 rounded-xl shadow-inner">
            <button id="b-av" onclick="setSide('front')" class="flex-1 py-2 text-[11px] font-black rounded-lg bg-white shadow-sm text-blue-600">AVANT</button>
            <button id="b-ar" onclick="setSide('back')" class="flex-1 py-2 text-[11px] font-black rounded-lg text-gray-400">ARRIÈRE</button>
        </div>
        
        <div class="bg-white rounded-2xl p-4 border border-gray-100 flex justify-center shadow-inner">
            <canvas id="c" width="280" height="280"></canvas>
        </div>

        <div class="flex items-center gap-3">
            <select id="logoSelect" class="ios-input" onchange="applyTextLogo(this.value)">
                <option value="">Logo Catalogue</option>
                <option>AVI-01</option><option>SXM-12</option><option>LION-05</option>
            </select>
            <label class="w-14 h-12 bg-white ios-card flex items-center justify-center cursor-pointer shadow-sm active:scale-90 transition-transform">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="var(--blue)" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                <input type="file" class="hidden" accept="image/*" onchange="handleUpload(event)">
            </label>
        </div>
        
        <textarea id="note" class="ios-input h-20" placeholder="Instructions particulières..."></textarea>
        
        <div class="flex gap-3">
            <button onclick="nav(2)" class="ios-btn bg-white !text-gray-400">Retour</button>
            <button onclick="nav(4)" class="ios-btn">Paiement</button>
        </div>
    </div>

    <div id="step-4" class="step">
        <div class="ios-card p-6 space-y-6">
            <div class="flex gap-4">
                <div class="flex-1"><p class="text-[10px] text-gray-400 font-bold text-center mb-1">PRIX UNITAIRE</p><input type="number" id="price" class="ios-input text-center font-bold" value="25" oninput="calcTotal()"></div>
                <div class="flex-1"><p class="text-[10px] text-gray-400 font-bold text-center mb-1">SUPPLÉMENT</p><input type="number" id="customPrice" class="ios-input text-center font-bold" value="0" oninput="calcTotal()"></div>
            </div>
            
            <div class="py-2">
                <p class="text-center text-[10px] text-gray-400 font-bold uppercase">Total</p>
                <h2 id="totalLabel" class="text-5xl font-black text-center tracking-tighter">25 €</h2>
            </div>

            <div id="payToggle" class="pay-toggle" onclick="togglePayment()">
                <div class="pay-slider"></div>
                <div class="pay-opt">EN ATTENTE</div>
                <div class="pay-opt opt-on">PAYÉ ✅</div>
            </div>
        </div>
        <button onclick="submit()" id="subBtn" class="ios-btn bg-black shadow-xl">Valider la commande</button>
    </div>

    <canvas id="exportCanvas" width="600" height="400" class="hidden"></canvas>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbxXM44btJkr0IrX6bG1Jw07iku9Uq_boToCpfTEWJSlFaE_QL-YDiBflPsCYWz4E8ck/exec";
        const COLORS = [{n:'Blanc',h:'#FFF'},{n:'Noir',h:'#1A1A1A'},{n:'Gris',h:'#8E8E93'},{n:'Rouge',h:'#FF3B30'},{n:'Bleu',h:'#007AFF'},{n:'Vert',h:'#34C759'},{n:'Jaune',h:'#FFCC00'},{n:'Rose',h:'#FF2D55'},{n:'Marine',h:'#00205B'},{n:'Orange',h:'#FF9500'}];
        
        let canvas, side = 'front', paid = false, storage = { front: null, back: null };

        window.onload = () => {
            canvas = new fabric.Canvas('c', { selection: false });
            // Génération ID Commande Apple style
            const d = new Date();
            document.getElementById('orderNo').value = `${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}${d.getDate().toString().padStart(2,'0')}-${d.getHours()}${d.getMinutes()}`;
            
            const ts = document.getElementById('tshirtColor'), lg = document.getElementById('logoColor');
            COLORS.forEach(c => {
                ts.add(new Option(c.n, c.n));
                lg.add(new Option(c.n, c.n));
            });
            ts.selectedIndex = 0; lg.selectedIndex = 1;
            
            syncUI(); updateRefs(); updatePreview();
        };

        function syncUI() {
            const tsV = document.getElementById('tshirtColor').value;
            const lgV = document.getElementById('logoColor').value;
            document.getElementById('ts-dot').style.backgroundColor = COLORS.find(c=>c.n===tsV).h;
            document.getElementById('lg-dot').style.backgroundColor = COLORS.find(c=>c.n===lgV).h;
        }

        function updateRefs() {
            const c = document.getElementById('collection').value, r = document.getElementById('refSelect');
            r.innerHTML = ''; if(c === 'Aucune') return;
            const prefix = c[0].toUpperCase();
            for(let i=1; i<=10; i++) {
                let v = prefix + i.toString().padStart(3,'0');
                r.add(new Option('Référence ' + v, v));
            }
        }

        function updatePreview() {
            canvas.clear();
            const hex = COLORS.find(c => c.n === document.getElementById('tshirtColor').value).h;
            const path = side === 'front' ? 
                "M 93,23 L 65,33 L 14,65 L 33,108 L 51,94 L 51,300 L 229,300 L 229,94 L 247,108 L 266,65 L 215,33 L 187,23 C 178,42 150,52 140,52 C 130,52 102,42 93,23 Z" :
                "M 93,23 L 65,33 L 14,65 L 33,108 L 51,94 L 51,300 L 229,300 L 229,94 L 247,108 L 266,65 L 215,33 L 187,23 C 182,28 165,33 140,33 C 115,33 98,28 93,23 Z";
            const ts = new fabric.Path(path, { left:140, top:140, fill:hex, stroke:'#eee', originX:'center', originY:'center', selectable:false, scaleX:0.85, scaleY:0.85 });
            canvas.add(ts);
            if(storage[side]) canvas.add(storage[side]);
            canvas.renderAll();
        }

        function setSide(s) {
            side = s;
            document.getElementById('b-av').className = s==='front'?'flex-1 py-2 text-[11px] font-black rounded-lg bg-white shadow-sm text-blue-600':'flex-1 py-2 text-[11px] font-black rounded-lg text-gray-400';
            document.getElementById('b-ar').className = s==='back'?'flex-1 py-2 text-[11px] font-black rounded-lg bg-white shadow-sm text-blue-600':'flex-1 py-2 text-[11px] font-black rounded-lg text-gray-400';
            updatePreview();
        }

        function applyTextLogo(v) {
            if(!v) return;
            const hex = COLORS.find(c => c.n === document.getElementById('logoColor').value).h;
            const txt = new fabric.Text(v, { left:140, top:100, fontSize:20, fill:hex, originX:'center', fontWeight:'bold', fontFamily:'Arial' });
            if(storage[side]) canvas.remove(storage[side]);
            storage[side] = txt; canvas.add(txt); canvas.setActiveObject(txt);
        }

        function handleUpload(e) {
            const reader = new FileReader();
            reader.onload = (f) => {
                fabric.Image.fromURL(f.target.result, (img) => {
                    img.scaleToWidth(60); img.set({ left:140, top:130, originX:'center' });
                    if(storage[side]) canvas.remove(storage[side]);
                    storage[side] = img; canvas.add(img); canvas.setActiveObject(img);
                });
            };
            reader.readAsDataURL(e.target.files[0]);
        }

        function togglePayment() { paid = !paid; document.getElementById('payToggle').classList.toggle('paid', paid); }
        function calcTotal() { document.getElementById('totalLabel').innerText = (parseFloat(document.getElementById('price').value)||0) + (parseFloat(document.getElementById('customPrice').value)||0) + " €"; }
        
        function nav(s) { 
            document.querySelectorAll('.step').forEach(e => e.classList.remove('active'));
            document.getElementById('step-'+s).classList.add('active');
            const titles = ["Client","Collection","Design","Paiement"];
            document.getElementById('step-title').innerText = titles[s-1];
            document.getElementById('step-label').innerText = `Étape ${s} sur 4`;
            document.getElementById('step-num').innerText = s;
            window.scrollTo(0,0);
        }

        async function submit() {
            const b = document.getElementById('subBtn'); b.innerText = "Traitement..."; b.disabled = true;
            
            // Capture des deux faces
            setSide('front'); await new Promise(r => setTimeout(r, 150));
            const imgAv = canvas.toDataURL();
            setSide('back'); await new Promise(r => setTimeout(r, 150));
            const imgAr = canvas.toDataURL();

            // Création de la fiche P
            const ec = document.getElementById('exportCanvas'), ctx = ec.getContext('2d');
            ctx.fillStyle = "white"; ctx.fillRect(0,0,600,400);
            const loadImg = (src) => new Promise(res => { const i = new Image(); i.onload = () => res(i); i.src = src; });
            const iav = await loadImg(imgAv), iar = await loadImg(imgAr);
            ctx.drawImage(iav, 10, 60, 280, 280); ctx.drawImage(iar, 310, 60, 280, 280);
            ctx.fillStyle = "#1c1c1e"; ctx.font = "bold 18px sans-serif";
            ctx.fillText("COMMANDE : " + document.getElementById('orderNo').value, 20, 40);
            ctx.font = "14px sans-serif";
            ctx.fillText("CLIENT : " + document.getElementById('clientName').value, 20, 370);

            const payload = {
                orderNo: document.getElementById('orderNo').value,
                client: document.getElementById('clientName').value,
                phone: document.getElementById('clientPhone').value,
                collection: document.getElementById('collection').value + " / " + document.getElementById('refSelect').value,
                size: document.getElementById('size').value,
                tshirtColor: document.getElementById('tshirtColor').value,
                logoColor: document.getElementById('logoColor').value,
                logoFront: storage.front ? (storage.front.text || "Image") : "Aucun",
                logoBack: storage.back ? (storage.back.text || "Image") : "Aucun",
                note: document.getElementById('note').value,
                total: document.getElementById('totalLabel').innerText,
                paid: paid ? "OUI" : "NON",
                image: ec.toDataURL('image/png')
            };

            fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then(() => {
                alert("Commande enregistrée avec succès !");
                location.reload();
            }).catch(() => {
                alert("Erreur réseau"); b.disabled = false; b.innerText = "Réessayer";
            });
        }
    </script>
</body>
</html>
